
R version 3.4.0 (2017-04-21) -- "You Stupid Darkness"
Copyright (C) 2017 The R Foundation for Statistical Computing
Platform: x86_64-pc-linux-gnu (64-bit)

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> args <- (commandArgs(trailingOnly = TRUE))
> for (i in 1:length(args)) {
+   eval(parse(text = args[[i]]))
+ }
> 
> print(gene)  ## gene of interest, or file listing collection of genes (one per row)
[1] "ENSG00000185658"
> print(bam)  ## bam file
[1] "STAR/20151016.A-Cortex_RNA/20151016.A-Cortex_RNA_Aligned.sortedByCoord.out.bam"
> print(bigwig)  ## bigwig file for visualization
[1] "STARbigwig/20151016.A-Cortex_RNA_Aligned.sortedByCoord.out.bw"
> print(genemodels)  ## gene models etc (output of alpine_prepare_for_comparison.R)
[1] "alpine/alpine_genemodels.rds"
> print(biasmodels)  ## bias model object (output of alpine_fitbiasmodel.R)
[1] "alpine/alpine_fitbiasmodel.rds"
> print(ncores)  ## number of cores for parallel computations
[1] 1
> print(outdir)  ## output directory
[1] "alpine_out"
> print(checkdir)  ## directory to write (empty) rds files (time stamps)
[1] "alpine_check"
> 
> suppressPackageStartupMessages(library(dplyr))
> suppressPackageStartupMessages(library(alpine))
> suppressPackageStartupMessages(library(GenomicAlignments))
> suppressPackageStartupMessages(library(BSgenome.Hsapiens.NCBI.GRCh38))
> suppressPackageStartupMessages(library(ggplot2))
> suppressPackageStartupMessages(library(cowplot))
> suppressPackageStartupMessages(library(ggrepel))
> suppressPackageStartupMessages(library(parallel))
> suppressPackageStartupMessages(library(grid))
> suppressPackageStartupMessages(library(gridExtra))
> 
> source("Rscripts/plot_tracks.R")
> 
> calc_prop_p <- function(coverage, uniqreads, tot_coverage, tot_reads) {
+   sapply(seq_along(coverage), function(i) {
+     prop.test(x = c(coverage[i], uniqreads[i]), n = c(tot_coverage[i], tot_reads[i]),
+               alternative = "two.sided")$p.value
+   })
+ }
> 
> ## Read gene models for Gviz plot (pregenerated from gtf to save time) and
> ## Salmon quantifications
> genemodels <- readRDS(genemodels)
> 
> ## Read bias model parameters and exon-by-transcript objects
> biasmodels <- readRDS(biasmodels)
> fitpar <- biasmodels$fitpar
> ebt0 <- biasmodels$ebt0
> txps <- biasmodels$txps
> 
> ## Estimate average fragment length
> avefraglength <- sum(fitpar$`1`$fraglen.density$x * fitpar$`1`$fraglen.density$y/
+                        sum(fitpar$`1`$fraglen.density$y))
> 
> ## Load bam file 
> bam.files <- bam
> names(bam.files) <- "1"
> 
> ## Determine which gene(s) to investigate
> if (file.exists(gene)) {
+   genes <- unlist(read.delim(gene, as.is = TRUE, header = FALSE))
+ } else {
+   genes <- gene
+ }
> 
> ## Investigate each gene
> mclapply(genes, function(currgene) {
+   ## Get transcripts for gene of interest
+   txlist <- names(subset(txps, gene_id == currgene))
+   names(txlist) <- txlist
+ 
+     if (length(txlist) > 0) {
+     
+     ## Predict coverage for each transcript
+     pred.cov <- lapply(txlist, function(tx) {
+       message(tx)
+       ## Get transcript model
+       txmod <- ebt0[[tx]]
+       
+       pc <- tryCatch({
+         m <- predictCoverage(gene = txmod,
+                              bam.files = bam.files,
+                              fitpar = fitpar,
+                              genome = Hsapiens,
+                              model.names = "all")
+         ## Scale predicted coverage to agree with Salmon's estimated count
+         m$`1`$pred.cov$all <- m$`1`$pred.cov$all/sum(m$`1`$pred.cov$all) * 
+           genemodels$quantsf$NumReads[genemodels$quantsf$Name == tx] * avefraglength
+         m
+       }, error = function(e) NULL)
+       pc
+     })
+     
+     junctionlist <- lapply(txlist, function(tx) {
+       txmod <- sort(ebt0[[tx]])
+       junctions <- GenomicRanges::setdiff(range(txmod), txmod)
+       if (all(strand(txmod) == "+")) {
+         junctionpos <- cumsum(width(txmod))
+         junctionpos <- junctionpos[-length(junctionpos)]
+         junctioncov <- as.numeric(pred.cov[[tx]]$"1"$pred.cov$all)[junctionpos]
+       } else if (all(strand(txmod) == "-")) {
+         junctionpos <- cumsum(width(rev(txmod)))
+         junctionpos <- junctionpos[-length(junctionpos)]
+         junctioncov <- as.numeric(pred.cov[[tx]]$"1"$pred.cov$all)[junctionpos]
+         junctioncov <- rev(junctioncov)
+       } else {
+         stop("Unknown or mixed strand")
+       }
+       mcols(junctions)$coverage <- junctioncov
+       junctions
+     })
+     
+     
+     jl <- do.call(rbind, lapply(junctionlist, as.data.frame)) %>% 
+       dplyr::group_by(seqnames, start, end, width, strand) %>%
+       dplyr::summarize(coverage = sum(coverage, na.rm = TRUE)) %>% ungroup() %>%
+       dplyr::mutate(coverage = replace(coverage, is.na(coverage), 0))
+     
+     jl <- dplyr::left_join(jl, genemodels$jcov) %>%
+       dplyr::mutate(uniqreads = replace(uniqreads, is.na(uniqreads), 0),
+                     mmreads = replace(mmreads, is.na(mmreads), 0)) %>%
+       dplyr::mutate(scaledcoverage = coverage/sum(coverage, na.rm = TRUE) * sum(uniqreads, na.rm = TRUE)) %>%
+       dplyr::mutate(tot_coverage = sum(coverage, na.rm = TRUE),
+                     tot_reads = sum(uniqreads, na.rm = TRUE)) %>%
+       dplyr::mutate(prop_pval = calc_prop_p(coverage, uniqreads, tot_coverage, tot_reads)) %>%
+       dplyr::mutate(junctionid = paste0("J", seq_len(length(scaledcoverage)))) %>% 
+       dplyr::mutate(difference = uniqreads - scaledcoverage) %>%
+       dplyr::mutate(ranking = order(order(difference))) %>%
+       dplyr::select(junctionid, everything())
+     
+     pdf(paste0(outdir, "/", currgene, ".pdf"), width = 12, height = 10)
+     tryCatch({
+       plot_tracks(mygene = currgene, genemodels = genemodels$genemodels_exon, 
+                   genemodels2 = genemodels$genemodels_cds, 
+                   gtf_file = NULL, rnaseq_datafiles = structure(bigwig, names = "s1"), 
+                   rnaseq_condition = structure("g1", names = "s1"), show_chr = NULL, 
+                   min_coord = NULL, max_coord = NULL, 
+                   pdf_filename = NULL, pdf_width = 7, pdf_height = 7)
+     }, error = function(e) message(e))
+     
+     grid.newpage()
+     grid.table(genemodels$quantsf %>% dplyr::filter(Name %in% txlist))
+     
+     grid.newpage()
+     grid.table(jl %>% dplyr::select(junctionid, seqnames, start, end, width, strand, 
+                                     uniqreads, mmreads, scaledcoverage, prop_pval))
+     
+     print(ggplot(jl, aes(x = scaledcoverage, y = uniqreads, label = junctionid)) + 
+             geom_point(size = 4) + geom_label_repel() + 
+             geom_abline(intercept = 0, slope = 1) + 
+             ggtitle(paste0("score = ", round(sum(abs(jl$uniqreads - jl$scaledcoverage), 
+                                                  na.rm = TRUE)/sum(jl$uniqreads, na.rm = TRUE), 2))) + 
+             xlab("Scaled predicted coverage") + ylab("Number of uniquely mapped reads"))
+     dev.off()
+     
+     write.table(jl %>%
+                   dplyr::mutate(coverage = round(coverage, 2),
+                                 scaledcoverage = round(scaledcoverage, 2),
+                                 difference = round(difference, 2)), 
+                 file = paste0(outdir, "/", gene, ".txt"),
+                 quote = FALSE, row.names = FALSE, col.names = TRUE, sep = "\t")
+     print(as.data.frame(jl))
+     
+     saveRDS(NULL, paste0(checkdir, "/", currgene, ".rds"))
+   }
+ }, mc.preschedule = FALSE, mc.cores = ncores)
ENST00000333229
ENST00000446924
ENST00000342449
ENST00000380800
ENST00000491564
ENST00000424441
ENST00000473813
ENST00000445668
ENST00000430093
ENST00000445245
ENST00000455867
ENST00000412604
ENST00000496759
ENST00000341322
ENST00000470108
ENST00000484090
Joining, by = c("seqnames", "start", "end", "strand")
   junctionid seqnames    start      end width strand    coverage uniqreads
1          J1       21 39187418 39196497  9080      -  69.7496239        16
2          J2       21 39194752 39196497  1746      -   0.1334553         2
3          J3       21 39197416 39198762  1347      - 101.0893024        55
4          J4       21 39199663 39200218   556      -  95.7194005        39
5          J5       21 39200387 39202324  1938      -  91.4161632        28
6          J6       21 39202546 39206107  3562      - 117.8603781        39
7          J7       21 39206275 39209994  3720      -  93.4599570        40
8          J8       21 39210148 39210785   638      - 120.2713248        48
9          J9       21 39210148 39210865   718      -   0.0000000         0
10        J10       21 39210148 39212665  2518      -   0.0000000         0
11        J11       21 39210930 39212665  1736      - 131.8137894        27
12        J12       21 39212708 39213480   773      - 115.0030754        28
13        J13       21 39213554 39215236  1683      -  91.0271217        23
14        J14       21 39215363 39218151  2789      - 108.9130371        31
15        J15       21 39215363 39218528  3166      -   0.0000000         0
16        J16       21 39218273 39218504   232      - 112.6961413        34
17        J17       21 39218661 39224407  5747      - 133.5381122        24
18        J18       21 39224470 39225085   616      - 110.4574975        24
19        J19       21 39225198 39228499  3302      -  99.2035744        26
20        J20       21 39228583 39229311   729      - 100.1685386        28
21        J21       21 39229437 39232176  2740      - 103.4516096        37
22        J22       21 39232285 39232372    88      - 105.5158452        27
23        J23       21 39232499 39236594  4096      - 116.9887285        26
24        J24       21 39236785 39238478  1694      - 135.7817459        17
25        J25       21 39238574 39247700  9127      - 139.1190710        20
26        J26       21 39238574 39250795 12222      -   0.0000000         0
27        J27       21 39247833 39250795  2963      - 113.4879994        23
28        J28       21 39250890 39255644  4755      -  87.0328038        17
29        J29       21 39250890 39255664  4775      -   0.1250435         1
30        J30       21 39250890 39258486  7597      -   0.0000000         0
31        J31       21 39255829 39258486  2658      -  80.6221803        19
32        J32       21 39258673 39264459  5787      - 101.5143112        23
33        J33       21 39264565 39264890   326      -   0.0000000         0
34        J34       21 39264686 39264890   205      -  87.7577119        34
35        J35       21 39264686 39264985   300      -   0.2670822         0
36        J36       21 39265020 39269898  4879      -  89.7140098        21
37        J37       21 39270034 39270282   249      - 109.5729715        30
38        J38       21 39270434 39274373  3940      -  94.4883304        14
39        J39       21 39274473 39276172  1700      - 109.8906248        25
40        J40       21 39276214 39277250  1037      -  93.5419310        28
41        J41       21 39277352 39278742  1391      -  67.4875533        13
42        J42       21 39278814 39280147  1334      -  56.1884347        15
43        J43       21 39280249 39293810 13562      -  50.5366367        32
44        J44       21 39294033 39295742  1710      -  56.7991752        18
45        J45       21 39295904 39296264   361      -  55.6334216        29
46        J46       21 39296364 39298431  2068      -  57.0937519        13
47        J47       21 39298583 39312840 14258      - 673.9058808       708
48        J48       21 39312901 39313071   171      - 363.4885678       266
49        J49       21 39313102 39313240   139      - 200.1177873       152
50        J50       21 39313300 39313442   143      -  68.4538672        43
51        J51       21 39313300 39321025  7726      -   6.5753273         0
   mmreads scaledcoverage tot_coverage tot_reads    prop_pval  difference
1        0    30.67882708     4917.673      2163 2.220614e-02 -14.6788271
2        0     0.05869929     4917.673      2163 2.072976e-01   1.9413007
3        0    44.46333979     4917.673      2163 2.309000e-01  10.5366602
4        0    42.10143042     4917.673      2163 7.547644e-01  -3.1014304
5        0    40.20868512     4917.673      2163 1.098711e-01 -12.2086851
6        2    51.83996643     4917.673      2163 1.400557e-01 -12.8399664
7        0    41.10763184     4917.673      2163 9.592557e-01  -1.1076318
8        0    52.90040251     4917.673      2163 6.228551e-01  -4.9004025
9        0     0.00000000     4917.673      2163          NaN   0.0000000
10       0     0.00000000     4917.673      2163          NaN   0.0000000
11       0    57.97726535     4917.673      2163 2.507007e-04 -30.9772654
12       0    50.58320416     4917.673      2163 5.352825e-03 -22.5832042
13       0    40.03756827     4917.673      2163 2.018455e-02 -17.0375683
14       0    47.90454839     4917.673      2163 3.717710e-02 -16.9045484
15       0     0.00000000     4917.673      2163          NaN   0.0000000
16       0    49.56851720     4917.673      2163 6.176398e-02 -15.5685172
17       0    58.73569528     4917.673      2163 3.586588e-05 -34.7356953
18       0    48.58386724     4917.673      2163 1.730122e-03 -24.5838672
19       0    43.63391710     4917.673      2163 2.146754e-02 -17.6339171
20       0    44.05834906     4917.673      2163 3.924406e-02 -16.0583491
21       0    45.50238216     4917.673      2163 3.172484e-01  -8.5023822
22       0    46.41032010     4917.673      2163 1.345945e-02 -19.4103201
23       0    51.45657817     4917.673      2163 1.626185e-03 -25.4565782
24       0    59.72254003     4917.673      2163 2.218976e-07 -42.7225400
25       0    61.19043640     4917.673      2163 9.937056e-07 -41.1904364
26       0     0.00000000     4917.673      2163          NaN   0.0000000
27       0    49.91680981     4917.673      2163 6.398490e-04 -26.9168098
28       0    38.28069873     4917.673      2163 2.197865e-03 -21.2806987
29       0     0.05499940     4917.673      2163 7.489754e-01   0.9450006
30       0     0.00000000     4917.673      2163          NaN   0.0000000
31       0    35.46103606     4917.673      2163 1.662527e-02 -16.4610361
32       0    44.65027660     4917.673      2163 4.324663e-03 -21.6502766
33       0     0.00000000     4917.673      2163          NaN   0.0000000
34       0    38.59954389     4917.673      2163 5.928155e-01  -4.5995439
35       0     0.11747401     4917.673      2163 1.000000e+00  -0.1174740
36       0    39.46000626     4917.673      2163 1.039847e-02 -18.4600063
37       0    48.19481537     4917.673      2163 2.428291e-02 -18.1948154
38       0    41.55995386     4917.673      2163 9.018776e-05 -27.5599539
39       0    48.33453272     4917.673      2163 3.033432e-03 -23.3345327
40       0    41.14368746     4917.673      2163 8.653546e-02 -13.1436875
41       0    29.68387301     4917.673      2163 6.966876e-03 -16.6838730
42       0    24.71404399     4917.673      2163 1.062082e-01  -9.7140440
43       0    22.22814479     4917.673      2163 1.307431e-01   9.7718552
44       0    24.98267343     4917.673      2163 2.723456e-01  -6.9826734
45       0    24.46992579     4917.673      2163 5.298386e-01   4.5300742
46       0    25.11224069     4917.673      2163 3.920967e-02 -12.1122407
47       0   296.41223619     4917.673      2163 4.989725e-77 411.5877638
48       0   159.87760645     4917.673      2163 3.216561e-11 106.1223935
49       0    88.02024514     4917.673      2163 1.843219e-07  63.9797549
50       0    30.10889864     4917.673      2163 7.974066e-02  12.8911014
51       0     2.89210635     4917.673      2163 2.012903e-01  -2.8921064
   ranking
1       23
2       44
3       47
4       33
5       26
6       25
7       35
8       31
9       37
10      38
11       4
12      10
13      17
14      18
15      39
16      22
17       3
18       8
19      16
20      21
21      29
22      13
23       7
24       1
25       2
26      40
27       6
28      12
29      43
30      41
31      20
32      11
33      42
34      32
35      36
36      14
37      15
38       5
39       9
40      24
41      19
42      28
43      46
44      30
45      45
46      27
47      51
48      50
49      49
50      48
51      34
[[1]]
NULL

> 
> saveRDS(NULL, paste0(checkdir, "/", gene, ".rds"))
> sessionInfo()
R version 3.4.0 (2017-04-21)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Ubuntu 14.04.5 LTS

Matrix products: default
BLAS: /usr/local/R/R-3.4.0/lib/libRblas.so
LAPACK: /usr/local/R/R-3.4.0/lib/libRlapack.so

locale:
 [1] LC_CTYPE=en_CA.UTF-8       LC_NUMERIC=C              
 [3] LC_TIME=en_CA.UTF-8        LC_COLLATE=en_CA.UTF-8    
 [5] LC_MONETARY=en_CA.UTF-8    LC_MESSAGES=en_CA.UTF-8   
 [7] LC_PAPER=en_CA.UTF-8       LC_NAME=C                 
 [9] LC_ADDRESS=C               LC_TELEPHONE=C            
[11] LC_MEASUREMENT=en_CA.UTF-8 LC_IDENTIFICATION=C       

attached base packages:
 [1] grid      stats4    parallel  stats     graphics  grDevices utils    
 [8] datasets  methods   base     

other attached packages:
 [1] Gviz_1.20.0                           
 [2] gridExtra_2.3                         
 [3] ggrepel_0.7.0                         
 [4] cowplot_0.8.0                         
 [5] ggplot2_2.2.1                         
 [6] BSgenome.Hsapiens.NCBI.GRCh38_1.3.1000
 [7] BSgenome_1.44.2                       
 [8] rtracklayer_1.36.4                    
 [9] GenomicAlignments_1.12.2              
[10] Rsamtools_1.28.0                      
[11] Biostrings_2.44.2                     
[12] XVector_0.16.0                        
[13] SummarizedExperiment_1.6.5            
[14] DelayedArray_0.2.7                    
[15] matrixStats_0.52.2                    
[16] Biobase_2.36.2                        
[17] GenomicRanges_1.28.5                  
[18] GenomeInfoDb_1.12.2                   
[19] IRanges_2.10.3                        
[20] S4Vectors_0.14.5                      
[21] BiocGenerics_0.22.0                   
[22] alpine_1.2.0                          
[23] dplyr_0.7.4                           

loaded via a namespace (and not attached):
 [1] ProtGenerics_1.8.0            bitops_1.0-6                 
 [3] bit64_0.9-7                   RColorBrewer_1.1-2           
 [5] httr_1.3.1                    tools_3.4.0                  
 [7] backports_1.1.1               R6_2.2.2                     
 [9] rpart_4.1-11                  Hmisc_4.0-3                  
[11] DBI_0.7                       lazyeval_0.2.0               
[13] colorspace_1.3-2              nnet_7.3-12                  
[15] curl_2.8.1                    bit_1.1-12                   
[17] compiler_3.4.0                graph_1.54.0                 
[19] htmlTable_1.9                 scales_0.5.0                 
[21] checkmate_1.8.4               RBGL_1.52.0                  
[23] speedglm_0.3-2                stringr_1.2.0                
[25] digest_0.6.12                 foreign_0.8-69               
[27] base64enc_0.1-3               dichromat_2.0-0              
[29] pkgconfig_2.0.1               htmltools_0.3.6              
[31] ensembldb_2.0.4               htmlwidgets_0.9              
[33] rlang_0.1.2                   RSQLite_2.0                  
[35] BiocInstaller_1.26.1          shiny_1.0.5                  
[37] bindr_0.1                     BiocParallel_1.10.1          
[39] acepack_1.4.1                 VariantAnnotation_1.22.3     
[41] RCurl_1.95-4.8                magrittr_1.5                 
[43] GenomeInfoDbData_0.99.0       Formula_1.2-2                
[45] Matrix_1.2-11                 Rcpp_0.12.13                 
[47] munsell_0.4.3                 stringi_1.1.5                
[49] yaml_2.1.14                   MASS_7.3-47                  
[51] zlibbioc_1.22.0               plyr_1.8.4                   
[53] AnnotationHub_2.8.2           blob_1.1.0                   
[55] lattice_0.20-35               splines_3.4.0                
[57] GenomicFeatures_1.28.5        knitr_1.17                   
[59] biomaRt_2.32.1                XML_3.98-1.9                 
[61] glue_1.1.1                    biovizBase_1.24.0            
[63] latticeExtra_0.6-28           data.table_1.10.4            
[65] httpuv_1.3.5                  gtable_0.2.0                 
[67] assertthat_0.2.0              mime_0.5                     
[69] xtable_1.8-2                  AnnotationFilter_1.0.0       
[71] survival_2.41-3               tibble_1.3.4                 
[73] AnnotationDbi_1.38.2          memoise_1.1.0                
[75] bindrcpp_0.2                  cluster_2.0.6                
[77] interactiveDisplayBase_1.14.0
> date()
[1] "Thu Nov  2 14:03:44 2017"
> 
> 
> proc.time()
   user  system elapsed 
 75.397  27.515 516.929 
